function [ ] = createMultiVariateWells( num )
%UNTITLED Creates for assay number num a file containing the gene list and
%the average value of each of the 20 features in all 6 bions. The result
%stored as a matrix

plate_paths={   
            '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1',...
       '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1',...
  '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1', ...
  '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1', ...
              '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130', ...
              '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130', ...
  '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1',  ...
   '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1',  ...
  '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran', ...
  '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091127_A431_w3ChtxAW2',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1',...
                       '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091113_A431_w3GPIGFP',...
        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100402_A431_w3Macro',...
        '/cluster/home/biol/heery/3NAS/Data/Users/Prisca/endocytome/110721_MZ_w2EGF'
       
                };
            
            out_path='/cluster/home/biol/heery/2NAS/Data/Users/Prisca/110315_Compounds_A431_Tf/modules/';
            
plate1_paths={  
     '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1/090203_Mz_Tf_EEA1_CP392-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1/090203_Mz_Tf_EEA1_CP393-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1/090203_Mz_Tf_EEA1_CP394-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1/090203_Mz_Tf_EEA1_CP395-1ad/BATCH', ...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1/090203_Mz_Tf_EEA1_CP392-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1/090203_Mz_Tf_EEA1_CP393-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1/090203_Mz_Tf_EEA1_CP394-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090203_MZ_w2Tf_w3EEA1/090203_Mz_Tf_EEA1_CP395-1ad/BATCH', ...
       '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1/090309_A431_Chtx_Lamp1_CP392-1ba/BATCH', ...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1/090309_A431_Chtx_Lamp1_CP393-1ba/BATCH', ...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1/090309_A431_Chtx_Lamp1_CP394-1ba/BATCH', ...
                           '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1/090309_A431_Chtx_Lamp1_CP395-1ba/BATCH', ...
                              '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1/090309_A431_Chtx_Lamp1_CP392-1ba/BATCH', ...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1/090309_A431_Chtx_Lamp1_CP393-1ba/BATCH', ...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1/090309_A431_Chtx_Lamp1_CP394-1ba/BATCH', ...
                           '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090928_A431_w2LAMP1_w3ChtxAW1/090309_A431_Chtx_Lamp1_CP395-1ba/BATCH', ...
              '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130/090309_A431-Chtx-GM130-CP392-1af/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130/090309_A431-Chtx-GM130-CP393-1af/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130/090309_A431-Chtx-GM130-CP394-1af/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130/090309_A431-Chtx-GM130-CP395-1af/BATCH', ...
                             '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130/090309_A431-Chtx-GM130-CP392-1af/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130/090309_A431-Chtx-GM130-CP393-1af/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130/090309_A431-Chtx-GM130-CP394-1af/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090309_A431_w2ChtxNAW_w3GM130/090309_A431-Chtx-GM130-CP395-1af/BATCH', ...
                                           '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1/090217_A431_Tf_EEA1_CP392-1ae/BATCH',  ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1/090217_A431_Tf_EEA1_CP393-1ae/BATCH', ...
                             '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1/090217_A431_Tf_EEA1_CP394-1ae/BATCH' , ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1/090217_A431_Tf_EEA1_CP395-1ae/BATCH', ...
                               '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1/090217_A431_Tf_EEA1_CP392-1ae/BATCH',  ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1/090217_A431_Tf_EEA1_CP393-1ae/BATCH', ...
                             '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1/090217_A431_Tf_EEA1_CP394-1ae/BATCH' , ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090217_A431_w2Tf_w3EEA1/090217_A431_Tf_EEA1_CP395-1ae/BATCH', ...
 '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran/090403_A431_Dextran_GM1-CP392-1ag/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran/090403_A431_Dextran_GM1-CP393-1ag/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran/090403_A431_Dextran_GM1-CP394-1ag/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran/090403_A431_Dextran_GM1-CP395-1ag/BATCH', ...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran/090403_A431_Dextran_GM1-CP392-1ag/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran/090403_A431_Dextran_GM1-CP393-1ag/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran/090403_A431_Dextran_GM1-CP394-1ag/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/090403_A431_w2GM1_w3Dextran/090403_A431_Dextran_GM1-CP395-1ag/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091127_A431_w3ChtxAW2/091127_A431_Chtx_Golgi_AcidWash_CP392-1bf/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091127_A431_w3ChtxAW2/091127_A431_Chtx_Golgi_AcidWash_CP393-1bf/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091127_A431_w3ChtxAW2/091127_A431_Chtx_Golgi_AcidWash_CP394-1bf/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091127_A431_w3ChtxAW2/091127_A431_Chtx_Golgi_AcidWash_CP395-1bf/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL/100215_A431_Actin_LDL_CP392-1bi/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL/100215_A431_Actin_LDL_CP393-1bi/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL/100215_A431_Actin_LDL_CP394-1bi/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL/100215_A431_Actin_LDL_CP395-1bi/BATCH',...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1/100224_A431_EGF_Cav1_CP392-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1/100224_A431_EGF_Cav1_CP393-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1/100224_A431_EGF_Cav1_CP394-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1/100224_A431_EGF_Cav1_CP395-1ba/BATCH',...
                                              '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1/100224_A431_EGF_Cav1_CP392-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1/100224_A431_EGF_Cav1_CP393-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1/100224_A431_EGF_Cav1_CP394-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100224_A431_w2EGF_w3CAV1/100224_A431_EGF_Cav1_CP395-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091113_A431_w3GPIGFP/091113_A431GPIGFP_CP392-1be/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091113_A431_w3GPIGFP/091113_A431GPIGFP_CP393-1be/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091113_A431_w3GPIGFP/091113_A431GPIGFP_CP394-1be/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/091113_A431_w3GPIGFP/091113_A431GPIGFP_CP395-1be/BATCH',...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100402_A431_w3Macro/100402_A431_Macropinocytosis_CP392-1bd/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100402_A431_w3Macro/100402_A431_Macropinocytosis_CP393-1bd/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100402_A431_w3Macro/100402_A431_Macropinocytosis_CP394-1bd/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100402_A431_w3Macro/100402_A431_Macropinocytosis_CP395-1bd/BATCH',...
                                                     '/cluster/home/biol/heery/3NAS/Data/Users/Prisca/endocytome/110721_MZ_w2EGF/110721_MZ_w2EGF-CP392-2ar/BATCH',...
                         '/cluster/home/biol/heery/3NAS/Data/Users/Prisca/endocytome/110721_MZ_w2EGF/110721_MZ_w2EGF-CP393-2ar/BATCH',...
                         '/cluster/home/biol/heery/3NAS/Data/Users/Prisca/endocytome/110721_MZ_w2EGF/110721_MZ_w2EGF-CP394-2ar/BATCH',...
                         '/cluster/home/biol/heery/3NAS/Data/Users/Prisca/endocytome/110721_MZ_w2EGF/110721_MZ_w2EGF-CP395-2ar/BATCH' };
                
   selected_assays=[1,4,6,7,8,9,10,11,12,13,14,15,16,17];  
       vesicle_strings6={'TfVes','EEA1Ves','ChtxVes','LampVes','ChtxVes','GM130Ves','EEA1Ves','TfVes','DextranVes','GM1Ves','ChtxVes','LDLVes','EGFVes','CavVes','GPIVes','MacroVes','EGFVes'};
  
for(assay1=num)
    assay=selected_assays(assay1);
    plate_paths2=         plate1_paths((assay-1)*4+1:assay*4);           

      
                   
plate_names={'CP392','CP393','CP394','CP395'};
count=1;
%plate_path_jpg={'/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL/100215_A431_Actin_LDL_CP392-1bi/JPG_SEGM','/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL/100215_A431_Actin_LDL_CP393-1bi/JPG_SEGM','/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL/100215_A431_Actin_LDL_CP394-1bi/JPG_SEGM','/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/endocytome/100215_A431_w3LDL/100215_A431_Actin_LDL_CP395-1bi/JPG_SEGM'}

row_translation={'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O'};
col_translation={'01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23'};

for(j=1:4)
    
    
    [temp_features,tempfeature_names,meta]=getRawProbModelData2(npc(plate_paths2{j}),npc(strcat(plate_paths{assay},'/RFEcp395_',vesicle_strings6{assay},'.txt')));

   % [f,~,meta]=getRawProbModelData2(plate_paths{j},strrep(plate_paths{j},'/BATCH','/ProbModel_Settings_Minimal.txt'));
% f(isnan(f))=0;
% corr_c=corr(f);
% HeatMap(corr_c,'RowLabels',fname','ColumnLabels',fname');
         basic_files=dir(npc(strcat(plate_paths2{j},'/*BASICDATA*')));
        if(size(basic_files,1)>1)
            sprintf(strcat('More than 1 basic data file:',basic_file{1}.name,' is used'))
        end;
        basic_data=basic_files.name;
        load(npc(strcat(plate_paths2{j},'/',basic_data)));
        gene_names=setdiff(BASICDATA.GeneData,{'Control',''});
                temp_features(find(temp_features~=temp_features))=0;
                NUM_POPULATION_FEATURES=4;
         orig_features=temp_features(:,NUM_POPULATION_FEATURES:23);
         feature_names=tempfeature_names(:,NUM_POPULATION_FEATURES:23);
         
          %  [obj.orig_features,obj.feature_names,meta] =getRawProbModelData2(strRootPath,config1_path);
           % [obj.features2,obj.feature2_names,meta2] =getRawProbModelData2(strRootPath,config2_path);
           features2=temp_features(:,1:NUM_POPULATION_FEATURES-1);
           [sorted_coefficients,bin_starts,bin_indices]=calculationPopulationScoreSize(features2,4,1);
               %[sorted_coefficients,bin_starts]=calculationPopulationScore(obj.features2,2,obj.pop_coef);

          
      
features = nanzscore(orig_features);

%Take median of all columns
total_med=nanmedian(features());

                      
              

median_c=NaN(24,20);
median_r=NaN(16,20);
median_c1=NaN(24,20);
median_r1=NaN(16,20);

%rng('shuffle');
for(bin=1:6)
                  for(col=1:max(BASICDATA.WellCol))
                     
                                     col_cells=find(BASICDATA.WellCol==col);
                                matNonTargetingImageIX = BASICDATA.ImageIndices(col_cells);
                matNonTargetingImageIX = cat(1,matNonTargetingImageIX{:});
                col_cells= ismember(meta(:,6),matNonTargetingImageIX);
                %Exclude cells not in current bin to do a plaet effect
                %correction accounting for population context
                col_cells=intersect(col_cells,sorted_coefficients(((bin_starts(bin):bin_starts(bin+1)))));
                median_c1(col,:)=nanmean(features(col_cells,:));
%                 Take average of row and upper and lower rowm for rows 3
%                 last row-1
                 features(col_cells,:)=bsxfun(@minus,features(col_cells,:),median_c1(col,:));
                          
                        end;
                       
%                   for(col=2:max(BASICDATA.WellCol)-1) 
%                            median_c(col,:)=nanmean(median_c1(max([2,col-1]):min([max(BASICDATA.WellCol)-1,col+1]),:),1);
%                              
%                         end;
                    for(row=1:max(BASICDATA.WellRow))
                        row_cells=find(BASICDATA.WellRow==row);
                                matNonTargetingImageIX = BASICDATA.ImageIndices(row_cells);
                matNonTargetingImageIX = cat(1,matNonTargetingImageIX{:});
                row_cells= ismember(meta(:,6),matNonTargetingImageIX);
                 row_cells=intersect(row_cells,sorted_coefficients(((bin_starts(bin):bin_starts(bin+1)))));
                median_r1(row,:)=nanmean(features(row_cells,:));
                    features(row_cells,:)=bsxfun(@minus,features(row_cells,:),median_r1(row,:));
                        
                    end;
%                       for(row=2:max(BASICDATA.WellRow)-1)
%                                median_r(row,:)=nanmean(median_r1(max(2,row-1):min(max(BASICDATA.WellRow)-1,row+1),:),1);
%                         features(row_cells,:)=bsxfun(@minus,features(row_cells,:),median_r(row,:));
%                 end;
end;
                
mean_well=NaN(length(gene_names),120);
cell_well=NaN(length(gene_names),120);
        for(gene=1:length(gene_names))
            
                            count=count+1;
                            
                            %Construct feature matrix just for the current gene
                            %
                            matGeneImageIX = BASICDATA.ImageIndices(strcmpi(BASICDATA.GeneData,gene_names(gene)'));
                            matGeneImageIX = cat(1,matGeneImageIX{:});
                            matGeneCellIX = ismember(meta(:,6),matGeneImageIX);
                           
                            
                            %Construct feature matrix just for the current
                   
                            %
                         
                            features1=features(matGeneCellIX,:);
                            index_v=1:size(sorted_coefficients,1);
                        %  log_control=ismember(1:length(sorted_coefficients), :);
                           log_treated=ismember(sorted_coefficients(:),index_v(matGeneCellIX));
                         treated_population=features(sorted_coefficients(log_treated(:)),:);
                    

                            %Loop over all bins (default is 10)
                            for(bin=1:6)% (length(bin_starts)-1))

%If either 
temp_vec=bin_starts(bin):bin_starts(bin+1);
%size_comp=b

                                 
%Check whether the bin is full
if(length(temp_vec)>1)
treated_population=features(sorted_coefficients(temp_vec(log_treated(bin_starts(bin):bin_starts(bin+1)))),:);
                                  control_population=features(sorted_coefficients(((bin_starts(bin):bin_starts(bin+1)))),:);
                              
%                     treated_population=features(sorted_coefficients((log_treated(:))),:);
%                                                       control_population=features(sorted_coefficients((log_control(:))),:);


                                % Stop if either of the two poulation has less than 200 cells
                                if((size(treated_population,1)<40))
                                    % sprintf('Cells with perturbed gene %s are not contained in bin %d',gene_names{gene},bin)
                                    continue;
                                end;
                                cell_well(gene,(bin-1)*20+1:bin*20)=size(treated_population,1);
                                mean_well(gene,(bin-1)*20+1:bin*20)=nanmean(treated_population);
end;
                            end;
        end;
        %Save gene_list,cell_numbers and mean_well
        save(npc(strcat(plate_paths2{j},'/','Measurements_MultiVariate_Wells','_',vesicle_strings6{assay},'.mat')),'gene_names','mean_well','feature_names','cell_well');
end;
            
end

