function [ output_args ] = computeGMM_part1( plate_paths,num_cluster )
%This function computes for different random subsets of data coming from all assays and plates a GMM. The
%optimal number of distributions to be used is detected bz means of a BIC
%criteria application.
%plate_paths:Paths of plates to bootrap vesicles from
%vesicle_file:Path to vesicle file
%settings_file:Path to vesicle settings used to read intensity files

if((assay_index>=10)||((assay_index>=2)&&(assay_index<=3)))
vesicle_file='Measurements_Vesicle_Features-v2';
      plate_paths={        
              '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090309_A431-Chtx-GM130/090309_A431-Chtx-GM130-CP392-1af/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090309_A431-Chtx-GM130/090309_A431-Chtx-GM130-CP393-1af/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090309_A431-Chtx-GM130/090309_A431-Chtx-GM130-CP394-1af/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090309_A431-Chtx-GM130/090309_A431-Chtx-GM130-CP395-1af/BATCH', ...
 '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090203_Mz_Tf_EEA1_harlink_03_1ad/090203_Mz_Tf_EEA1_CP392-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090203_Mz_Tf_EEA1_harlink_03_1ad/090203_Mz_Tf_EEA1_CP393-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090203_Mz_Tf_EEA1_harlink_03_1ad/090203_Mz_Tf_EEA1_CP394-1ad/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090203_Mz_Tf_EEA1_harlink_03_1ad/090203_Mz_Tf_EEA1_CP395-1ad/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090217_A431_Tf_EEA1/090217_A431_Tf_EEA1_CP392-1ae/BATCH',  ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090217_A431_Tf_EEA1/090217_A431_Tf_EEA1_CP393-1ae/BATCH', ...
                             '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090217_A431_Tf_EEA1/090217_A431_Tf_EEA1_CP394-1ae/BATCH' , ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090217_A431_Tf_EEA1/090217_A431_Tf_EEA1_CP395-1ae/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090928_A431_Chtx_Lamp1/090309_A431_Chtx_Lamp1_CP392-1ba/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090928_A431_Chtx_Lamp1/090309_A431_Chtx_Lamp1_CP393-1ba/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090928_A431_Chtx_Lamp1/090309_A431_Chtx_Lamp1_CP394-1ba/BATCH', ...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090928_A431_Chtx_Lamp1/090309_A431_Chtx_Lamp1_CP395-1ba/BATCH', ...
                           '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090403_A431_Dextran_GM1/090403_A431_Dextran_GM1-CP392-1ag/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090403_A431_Dextran_GM1/090403_A431_Dextran_GM1-CP393-1ag/BATCH', ...
                        '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090403_A431_Dextran_GM1/090403_A431_Dextran_GM1-CP394-1ag/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/090403_A431_Dextran_GM1/090403_A431_Dextran_GM1-CP395-1ag/BATCH', ...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/091127_A431_Chtx_Golgi_AcidWash/091127_A431_Chtx_Golgi_AcidWash_CP392-1bf/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/091127_A431_Chtx_Golgi_AcidWash/091127_A431_Chtx_Golgi_AcidWash_CP393-1bf/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/091127_A431_Chtx_Golgi_AcidWash/091127_A431_Chtx_Golgi_AcidWash_CP394-1bf/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/091127_A431_Chtx_Golgi_AcidWash/091127_A431_Chtx_Golgi_AcidWash_CP395-1bf/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100215_A431_Actin_LDL/100215_A431_Actin_LDL_CP392-1bi/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100215_A431_Actin_LDL/100215_A431_Actin_LDL_CP393-1bi/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100215_A431_Actin_LDL/100215_A431_Actin_LDL_CP394-1bi/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100215_A431_Actin_LDL/100215_A431_Actin_LDL_CP395-1bi/BATCH',...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100224_A431_EGF_Cav1/100224_A431_EGF_Cav1_CP392-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100224_A431_EGF_Cav1/100224_A431_EGF_Cav1_CP393-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100224_A431_EGF_Cav1/100224_A431_EGF_Cav1_CP394-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100224_A431_EGF_Cav1/100224_A431_EGF_Cav1_CP395-1ba/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/091113_A431_GPIGFP/091113_A431GPIGFP_CP392-1be/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/091113_A431_GPIGFP/091113_A431GPIGFP_CP393-1be/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/091113_A431_GPIGFP/091113_A431GPIGFP_CP394-1be/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/091113_A431_GPIGFP/091113_A431GPIGFP_CP395-1be/BATCH',...
                          '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100402_A431_Macropinocytosis/100402_A431_Macropinocytosis_CP392-1bd/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100402_A431_Macropinocytosis/100402_A431_Macropinocytosis_CP393-1bd/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100402_A431_Macropinocytosis/100402_A431_Macropinocytosis_CP394-1bd/BATCH',...
                         '/BIOL/imsb/fs3/bio3/bio3/Data/Users/Prisca/100402_A431_Macropinocytosis/100402_A431_Macropinocytosis_CP395-1bd/BATCH'};
           
                     %Draw 100 times a random sample
                     %Allocate space for 1000000 vesicles
                     if(~exist(strcat('/cluster/home/biol/lprisca/ves_gmm/ves_gmm',sprintf('%d',ceil(assay_index)),'/','Measurements_GMM',sprintf('%d',num_cluster),'.mat'),'file'))
                   %Allocate space to sotre all vesicle feature including
                   %the intensitz features
                         vesicles=NaN(length(plate_paths)*10000,10);
                         vesicle_count=1;
                         for(plate=1:4)
                             load(strcat(plate_paths{plate},'/','Measurements_Cells_CustomSingle',vesicle_name,'.mat'));
                             ves=eval(strcat('handles.Measurements.Cells.CustomSingle.',vesicle_name));
                               load(strcat(plate_paths{plate},'/','Measurements_',vesicle_name,'_Intensity_',channel_name,'.mat'));
                             ves_intensity=eval(strcat('handles.Measurements.',vesicle_name,'.Intensity.',channel_name));
                             %Loop over images
                             for(image=1:max(meta(:,5)))
                                 I=find(meta(:,5)==image);
                                 if(~isempty(I))
                                     %Image contains cells after cleanup
                                     ves_image=ves_intensity{image};
                             vesicle_count=vesicle_count+ves_image(parent(find(ismember)));
                         end;
                     log_like=NaN(1,100);
                     BIC=NaN(1,100);
                     AIC=NaN(1,100);
         
                         %Loop over clusters
                     for(boot=1:100)
                       
                     vesicle_features1=[];
                     count=1;
                     
    for(plate=1:4)
        %Derive path of vesicle and cell file using the assay and the plate
        %indices
        plate1=(assay-1)*4+plate;
        vesicle_path=npc(strcat('/cluster/home/biol/lprisca/vesicles/ves',sprintf('%d',ceil(assay_index)),'/',vesicle_file,sprintf('%d',plate1),'.mat'));
     %   vesicle_path=strcat('C:\Users\heery\Desktop\vesicles\ves',sprintf('%d',assay),'\Measurements_Vesicle_Features-v2',sprintf('%d',plate1),'.mat');
        if(exist(vesicle_path,'file'))
            load(vesicle_path);
              vesicle_features=cat(1,vesicle_features{:});
              %Draw 20000 vesicles at random from the total set
              vesicles(count:count+9999,:)=vesicle_features(randi(size(vesicle_features,1),[10000,1]),:);
              count=count+10000;
 clear vesicle_features;
        end;
    end;

[IX,IY]=find(isnan(vesicles));
vesicles(IX,:)=[];
    %Train GMM in first iteration
    if(size(vesicles,1)>100)
results=gmdistribution.fit(vesicles(1:end,1:5),num_cluster);

AIC(boot)=results.AIC;
BIC(boot)=results.BIC;
    %Just get log likelihood
[~,log_like(boot)]=cluster(results,vesicles(1:end,1:5));
end;
                     end;
                     
         
 mkdir(strcat('/cluster/home/biol/lprisca/ves_gmm/ves_gmm',sprintf('%d',ceil(assay_index))));                 
 save((strcat('/cluster/home/biol/lprisca/ves_gmm/ves_gmm',sprintf('%d',ceil(assay_index)),'/','Measurements_GMM',sprintf('%d',num_cluster))),'log_like','AIC','BIC');
end;
end;
end
